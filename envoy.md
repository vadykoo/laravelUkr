git 0ab96f0b7c55966f5402b99e37268a0e9dacd03e

---

# Envoy Laravel

[comment]: <> (-   [Вступ]&#40;#introduction&#41;)

[comment]: <> (    -   [Встановлення]&#40;#installation&#41;)

[comment]: <> (-   [Написання завдань]&#40;#writing-tasks&#41;)

[comment]: <> (    -   [Налаштування]&#40;#setup&#41;)

[comment]: <> (    -   [Змінні]&#40;#variables&#41;)

[comment]: <> (    -   [Історії]&#40;#stories&#41;)

[comment]: <> (    -   [Кілька серверів]&#40;#multiple-servers&#41;)

[comment]: <> (-   [Запуск завдань]&#40;#running-tasks&#41;)

[comment]: <> (    -   [Підтвердження виконання завдання]&#40;#confirming-task-execution&#41;)

[comment]: <> (-   [Повідомлення]&#40;#notifications&#41;)

[comment]: <> (    -   [Slack]&#40;#slack&#41;)

[comment]: <> (    -   [Discord]&#40;#discord&#41;)

[comment]: <> (    -   [Telegram]&#40;#telegram&#41;)

<a name="introduction"></a>

## Вступ

[Envoy Laravel](https://github.com/laravel/envoy)забезпечує чіткий мінімальний синтаксис для визначення загальних завдань, які ви запускаєте на віддалених серверах. Використовуючи синтаксис стилю Blade, ви можете легко налаштувати завдання для розгортання, команди Artisan тощо. В даний час Envoy підтримує лише операційні системи Mac і Linux.

<a name="installation"></a>

### Встановлення

Спочатку встановіть Envoy за допомогою Composer`global require`команди:

    composer global require laravel/envoy

Оскільки глобальні бібліотеки Composer іноді можуть спричиняти конфлікти версій пакетів, ви можете розглянути можливість використання`cgr`, що є заміною для`composer global require`команди.`cgr`інструкції з встановлення бібліотеки можна знайти[на GitHub](https://github.com/consolidation-org/cgr).

> {note} Обов’язково розмістіть`$HOME/.config/composer/vendor/bin`або`$HOME/.composer/vendor/bin`каталог у вашому PATH, так що`envoy`виконуваний файл знайдено під час запуску`envoy`у вашому терміналі.

<a name="updating-envoy"></a>

#### Оновлення Envoy

Ви також можете використовувати Composer, щоб підтримувати оновлення програми Envoy. Видача`composer global update`команда оновить усі ваші глобально встановлені пакети Composer:

    composer global update

<a name="writing-tasks"></a>

## Написання завдань

Всі ваші завдання Envoy повинні бути визначені в`Envoy.blade.php`файл у кореневій частині вашого проекту. Ось приклад для початку:

    @servers(['web' => ['user@192.168.1.1']])

    @task('foo', ['on' => 'web'])
        ls -la
    @endtask

Як бачите, масив`@servers`визначається у верхній частині файлу, що дозволяє посилатися на ці сервери в `on` опцію декларацій ваших завдань.`@servers` декларація повинна бути завжди розміщена в одному рядку. В межах `@task` декларації, вам слід розмістити код Bash, який повинен працювати на вашому сервері під час виконання завдання.

Ви можете змусити скрипт запускатися локально, вказавши IP-адресу сервера як`127.0.0.1`:

    @servers(['localhost' => '127.0.0.1'])

<a name="setup"></a>

### Налаштування

Іноді вам може знадобитися виконати якийсь PHP-код перед виконанням завдань Envoy. Ви можете використовувати`@setup`директиву для оголошення змінних та виконання інших загальних PHP-робіт перед виконанням будь-яких інших ваших завдань:

    @setup
        $now = new DateTime();

        $environment = isset($env) ? $env : "testing";
    @endsetup

Якщо вам потрібно підключити інші файли PHP перед тим, як ваше завдання буде виконано, ви можете використовувати `@include` директиву у верхній частині вашого `Envoy.blade.php` файлу:

    @include('vendor/autoload.php')

    @task('foo')
        # ...
    @endtask

Ви також можете імпортувати інші файли Envoy, щоб їх історії та завдання були додані до ваших. Після їх імпортування ви можете виконувати завдання у цих файлах так, ніби вони були визначені у вашому власному. Ви повинні використовувати `@import` директиву у верхній частині вашого`Envoy.blade.php` файлу:

    @import('package/Envoy.blade.php')

<a name="variables"></a>

### Змінні

За потреби ви можете передавати значення параметрів у завдання Envoy за допомогою командного рядка:

    envoy run deploy --branch=master

Ви можете отримати доступ до опцій у своїх завданнях за допомогою синтаксису Blade "echo". Ви також можете використовувати`if`оператори та цикли в межах ваших завдань. Наприклад, давайте перевіримо наявність `$branch` змінної перед виконанням `git pull` команди:

    @servers(['web' => '192.168.1.1'])

    @task('deploy', ['on' => 'web'])
        cd site

        @if ($branch)
            git pull origin {{ $branch }}
        @endif

        php artisan migrate
    @endtask

<a name="stories"></a>

### Історії

Історії групують набір завдань під єдиною зручною назвою, що дозволяє згрупувати невеликі цілеспрямовані завдання у великі завдання. Наприклад, a`deploy`історія може запускати`git`і`composer`завдання, перерахувавши назви завдань у його визначенні:

    @servers(['web' => '192.168.1.1'])

    @story('deploy')
        git
        composer
    @endstory

    @task('git')
        git pull origin master
    @endtask

    @task('composer')
        composer install
    @endtask

Після написання історії ви можете запустити її так само, як типове завдання:

    envoy run deploy

<a name="multiple-servers"></a>

### Кілька серверів

Envoy дозволяє легко запускати завдання на декількох серверах. Спочатку додайте додаткові сервери до вашого`@servers`декларації. Кожному серверу слід присвоїти унікальне ім'я. Визначивши додаткові сервери, перелічіть кожен із серверів у задачі`on`масив:

    @servers(['web-1' => '192.168.1.1', 'web-2' => '192.168.1.2'])

    @task('deploy', ['on' => ['web-1', 'web-2']])
        cd site
        git pull origin {{ $branch }}
        php artisan migrate
    @endtask

<a name="parallel-execution"></a>

#### Паралельне виконання

За замовчуванням завдання будуть виконуватися на кожному сервері послідовно. Іншими словами, завдання завершиться на першому сервері перед тим, як приступити до виконання на другому сервері. Якщо ви хочете запустити завдання на кількох серверах паралельно, додайте`parallel`варіант декларації вашого завдання:

    @servers(['web-1' => '192.168.1.1', 'web-2' => '192.168.1.2'])

    @task('deploy', ['on' => ['web-1', 'web-2'], 'parallel' => true])
        cd site
        git pull origin {{ $branch }}
        php artisan migrate
    @endtask

<a name="running-tasks"></a>

## Запуск завдань

Щоб запустити завдання або історію, визначену у вашому`Envoy.blade.php`файл, виконайте Envoy's`run`команда, передаючи назву завдання або історії, яку ви хотіли б виконати. Envoy запустить завдання та відобразить вихідні дані із серверів під час виконання завдання:

    envoy run deploy

<a name="confirming-task-execution"></a>

### Підтвердження виконання завдання

Якщо ви хочете отримати запит на підтвердження перед запуском заданого завдання на своїх серверах, вам слід додати файл`confirm`директиву до оголошення вашого завдання. Цей параметр особливо корисний для руйнівних операцій:

    @task('deploy', ['on' => 'web', 'confirm' => true])
        cd site
        git pull origin {{ $branch }}
        php artisan migrate
    @endtask

<a name="notifications"></a>

## Повідомлення

<a name="slack"></a>

### Slack

Envoy також підтримує надсилання повідомлень до[Slack](https://slack.com)після виконання кожного завдання.`@slack`директива приймає URL-адресу підключення Slack та назву каналу. Ви можете отримати URL-адресу веб-хука, створивши інтеграцію "Вхідні веб-хуки" на панелі керування Slack. Вам слід передати всю URL-адресу веб-хука в`@slack`директива:

    @finished
        @slack('webhook-url', '#bots')
    @endfinished

В якості аргументу каналу ви можете вказати одне з наступного:

<div class="content-list" markdown="1">
- To send the notification to a channel: `#channel`
- To send the notification to a user: `@user`
</div>

<a name="discord"></a>

### Discord

Envoy також підтримує надсилання повідомлень до[Discord](https://discord.com)після виконання кожного завдання.`@discord`директива приймає URL-адресу та повідомлення про перехід Discord. Ви можете отримати URL-адресу веб-хука, створивши "Веб-хук" у налаштуваннях сервера та вибравши, на якому каналі веб-хук повинен розміщувати повідомлення. Вам слід передати всю URL-адресу Webhook в`@discord`директиву:

    @finished
        @discord('discord-webhook-url')
    @endfinished

<a name="telegram"></a>

### Telegram

Envoy також підтримує надсилання повідомлень до[Telegram](https://telegram.org)після виконання кожного завдання.`@telegram`директива приймає ідентифікатор бота Telegram та чат IF. Ви можете отримати свій ідентифікатор бота, створивши нового бота за допомогою[BotFather](https://t.me/botfather). Ви можете отримати дійсний ідентифікатор чату за допомогою[@username_to_id_bot](https://t.me/username_to_id_bot). Ви повинні передати весь ідентифікатор бота та ідентифікатор чату в`@telegram`директиву:

    @finished
        @telegram('<bot-id>','<chat-id>')
    @endfinished
